/*!
  backbone.fetch-cache v0.1.1 (2012-12-19)
  by Andy Appleton - https://github.com/mrappleton/backbone-fetch-cache.git
 */
(function(){function r(e,t,n){t=t||{};var r=_.isFunction(e.url)?e.url():e.url,i=!1;if(!r)return;t.expires!==!1&&(i=(new Date).getTime()+(t.expires||300)*1e3),Backbone.fetchCache._cache[r]={expires:i,value:n},Backbone.fetchCache.setLocalStorage()}function i(){if(!n||!Backbone.fetchCache.localStorage)return;localStorage.setItem("backboneCache",JSON.stringify(Backbone.fetchCache._cache))}function s(){if(!n||!Backbone.fetchCache.localStorage)return;Backbone.fetchCache._cache=JSON.parse(localStorage.getItem("backboneCache"))||{}}var e=Backbone.Model.prototype.fetch,t=Backbone.Collection.prototype.fetch,n=typeof window.localStorage!="undefined";Backbone.fetchCache=Backbone.fetchCache||{},Backbone.fetchCache._cache=Backbone.fetchCache._cache||{},typeof Backbone.fetchCache.localStorage=="undefined"&&(Backbone.fetchCache.localStorage=!0),Backbone.Model.prototype.fetch=function(t){t=t||{};var n=_.isFunction(this.url)?this.url():this.url,r=Backbone.fetchCache._cache[n],i=!1,s=!1,o=new $.Deferred;r&&(i=r.expires,i=i&&r.expires<(new Date).getTime(),s=r.value);if(!i&&(t.cache||t.prefill)&&s){this.set(s,t),_.isFunction(t.prefillSuccess)&&t.prefillSuccess(this);if(!t.prefill)return _.isFunction(t.success)&&t.success(this),o.resolve(this);o.notify(this)}return e.apply(this,arguments).done(_.bind(o.resolve,this,this)).done(_.bind(Backbone.fetchCache.setCache,null,this,t)),o},Backbone.Collection.prototype.fetch=function(e){e=e||{};var n=_.isFunction(this.url)?this.url():this.url,r=Backbone.fetchCache._cache[n],i=!1,s=!1,o=new $.Deferred;r&&(i=r.expires,i=i&&r.expires<(new Date).getTime(),s=r.value);if(!i&&(e.cache||e.prefill)&&s){this[e.add?"add":"reset"](this.parse(s),e),_.isFunction(e.prefillSuccess)&&e.prefillSuccess(this);if(!e.prefill)return _.isFunction(e.success)&&e.success(this),o.resolve(this);o.notify(this)}return t.apply(this,arguments).done(_.bind(o.resolve,this,this)).done(_.bind(Backbone.fetchCache.setCache,null,this,e)),o},s(),Backbone.fetchCache.setCache=r,Backbone.fetchCache.setLocalStorage=i,Backbone.fetchCache.getLocalStorage=s})();